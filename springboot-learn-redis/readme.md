### # Redis
* SpringAOP+Rediså®ç°åˆ†å¸ƒå¼é”
* ç›‘å¬Redisä¸­keyçš„è¿‡æœŸäº‹ä»¶
* ä½¿ç”¨Redisç”Ÿæˆæµæ°´å·



* ç¼“å­˜
    * ç¼“å­˜ç©¿é€->æŸ¥è¯¢ä¸å­˜åœ¨çš„å€¼
        * ç¼“å­˜ä¸å­˜åœ¨çš„å€¼åœ¨cacheä¸­ï¼Œä¸‹æ¬¡ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›null
        * åœ¨cacheå‰é¢å†åŠ ä¸Šä¸€å±‚bloomFilterï¼Œå…ˆä»bloomFilterä¸­æŸ¥è¯¢keyæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç»§ç»­å¾€ä¸‹èµ°cacheï¼Œèµ°DBã€‚å¦åˆ™ç›´æ¥è¿”å›nullã€‚
    * ç¼“å­˜å‡»ç©¿->å¯¹äºè®¿é—®é‡å¾ˆå¤§çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨æŸä¸€æ—¶åˆ»ç¼“å­˜å¤±æ•ˆï¼Œé‚£ä¹ˆä¼šæœ‰å¤§é‡çš„è¯·æ±‚æ‰“åˆ°DBï¼Œå¯¼è‡´DBå®•æœº
        * åœ¨ç¬¬ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ä¸ŠåŠ ä¸Šäº’æ–¥é”ï¼Œå…¶ä»–çº¿ç¨‹ç­‰ç¬¬ä¸€ä¸ªè¯·æ±‚ç¼“å­˜å®Œæˆä¹‹åå†æ‰§è¡Œï¼ˆå¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œåˆ™è·å–äº’æ–¥é”ï¼ŒæŸ¥è¯¢å®Œæˆä¹‹åå°†æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œå†è®²äº’æ–¥é”é‡Šæ”¾ï¼‰
        * ~~æˆ–è€…ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—~~
        * åå°ç»´æŠ¤ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥æ£€æŸ¥ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼Œå¦‚æœå‘ç°æœ‰ç¼“å­˜å³å°†è¿‡æœŸï¼Œåˆ™åœ¨è¿‡æœŸä¹‹å‰æ›´æ–°ç¼“å­˜ï¼ˆç¼ºç‚¹æ˜¯ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼‰
    * ç¼“å­˜é›ªå´©->ç¼“å­˜æœåŠ¡å™¨å®•æœºæˆ–è€…æŸä¸€æ—¶åˆ»å¤§é‡çš„çƒ­ç‚¹æ•°æ®å¤±æ•ˆ
        * åšå¥½é›†ç¾¤ç¼“å­˜ï¼Œæé«˜ç¼“å­˜çš„å¯ç”¨æ€§
        * æœåŠ¡é™çº§ï¼ˆå¯¹æ‰€æœ‰çš„é—®é¢˜éƒ½æœ‰æ•ˆï¼‰
        * å¯¹ç¼“å­˜çš„æ•°æ®è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼ˆå…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼‰

å‚è€ƒ
* [https://blog.csdn.net/u010416101/article/details/79690404](https://blog.csdn.net/u010416101/article/details/79690404)
* [https://blog.csdn.net/liubenlong007/article/details/53690103](https://blog.csdn.net/liubenlong007/article/details/53690103)
* [https://www.cnblogs.com/xingzc/p/5988080.html](https://www.cnblogs.com/xingzc/p/5988080.html)



#### # Redisæœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ
[å­—ç¬¦ä¸²ï¼ˆstringsï¼‰](http://www.redis.cn/topics/data-types-intro.html#strings)ï¼ŒÂ [æ•£åˆ—ï¼ˆhashesï¼‰](http://www.redis.cn/topics/data-types-intro.html#hashes)ï¼ŒÂ [åˆ—è¡¨ï¼ˆlistsï¼‰](http://www.redis.cn/topics/data-types-intro.html#lists)ï¼ŒÂ [é›†åˆï¼ˆsetsï¼‰](http://www.redis.cn/topics/data-types-intro.html#sets)ï¼ŒÂ [æœ‰åºé›†åˆï¼ˆsorted setsï¼‰](http://www.redis.cn/topics/data-types-intro.html#sorted-sets)Â ä¸èŒƒå›´æŸ¥è¯¢ï¼ŒÂ [bitmaps](http://www.redis.cn/topics/data-types-intro.html#bitmaps)ï¼ŒÂ [hyperloglogs](http://www.redis.cn/topics/data-types-intro.html#hyperloglogs)Â å’ŒÂ [åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰](http://www.redis.cn/commands/geoadd.html)Â ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚

### # ä½¿ç”¨è¿‡Redisåˆ†å¸ƒå¼é”ä¹ˆï¼Œå®ƒæ˜¯ä»€ä¹ˆå›äº‹ï¼Ÿ
å…ˆæ‹¿setnxï¼ˆSET if Not existsï¼‰æ¥äº‰æŠ¢é”ï¼ŒæŠ¢åˆ°ä¹‹åï¼Œå†ç”¨expireç»™é”åŠ ä¸€ä¸ªè¿‡æœŸæ—¶é—´é˜²æ­¢é”å¿˜è®°äº†é‡Šæ”¾ã€‚
~~æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯`SETNX lock.foo <current Unix time + lock timeout + 1>`ï¼Œå°†lock.fooçš„å€¼è®¾ç½®ä¸ºè¿‡æœŸæ—¶é—´ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å¯ä»¥é€šè¿‡è¿™ä¸ªå‚æ•°æ¥åˆ¤æ–­è¯¥é”æ˜¯å¦å·²ç»å¤±æ•ˆï¼Œå¦‚æœå‘ç°å·²ç»è¶…æ—¶ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å¯ä»¥å°†å…¶åˆ é™¤ã€‚~~(æ²¡ææ˜ç™½)
[http://www.redis.cn/commands/setnx.html](http://www.redis.cn/commands/setnx.html)

### # å‡å¦‚Redisé‡Œé¢æœ‰1äº¿ä¸ªkeyï¼Œå…¶ä¸­æœ‰10wä¸ªkeyæ˜¯ä»¥æŸä¸ªå›ºå®šçš„å·²çŸ¥çš„å‰ç¼€å¼€å¤´çš„ï¼Œå¦‚æœå°†å®ƒä»¬å…¨éƒ¨æ‰¾å‡ºæ¥ï¼Ÿ
ä½¿ç”¨keysæŒ‡ä»¤å¯ä»¥æ‰«å‡ºæŒ‡å®šæ¨¡å¼çš„keyåˆ—è¡¨ã€‚ä½†æ˜¯Redisçš„å•çº¿ç¨‹çš„ã€‚keysæŒ‡ä»¤ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œçº¿ä¸ŠæœåŠ¡ä¼šåœé¡¿ï¼Œç›´åˆ°æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼ŒæœåŠ¡æ‰èƒ½æ¢å¤ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨scanæŒ‡ä»¤ï¼ŒscanæŒ‡ä»¤å¯ä»¥æ— é˜»å¡çš„æå–å‡ºæŒ‡å®šæ¨¡å¼çš„keyåˆ—è¡¨ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€å®šçš„é‡å¤æ¦‚ç‡ï¼Œåœ¨å®¢æˆ·ç«¯åšä¸€æ¬¡å»é‡å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ•´ä½“æ‰€èŠ±è´¹çš„æ—¶é—´ä¼šæ¯”ç›´æ¥ç”¨keysæŒ‡ä»¤é•¿ã€‚(æˆ‘ç†è§£çš„scanæ˜¯ç±»ä¼¼äºåˆ†é¡µæŸ¥è¯¢)

### # ä½¿ç”¨è¿‡Redisåšå¼‚æ­¥é˜Ÿåˆ—ä¹ˆï¼Œä½ æ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ
ä¸€èˆ¬ä½¿ç”¨listç»“æ„ä½œä¸ºé˜Ÿåˆ—ï¼Œrpushç”Ÿäº§æ¶ˆæ¯ï¼Œlpopæ¶ˆè´¹æ¶ˆæ¯ã€‚å½“lpopæ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¦é€‚å½“sleepä¸€ä¼šå†é‡è¯•ã€‚
å¦‚æœå¯¹æ–¹è¿½é—®å¯ä¸å¯ä»¥ä¸ç”¨sleepå‘¢ï¼Ÿlistè¿˜æœ‰ä¸ªæŒ‡ä»¤å«blpopï¼Œåœ¨æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¼šé˜»å¡ä½ç›´åˆ°æ¶ˆæ¯åˆ°æ¥ã€‚ 

### # æ·˜æ±°ç­–ç•¥
åœ¨ redis ä¸­ï¼Œå…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§ä½¿ç”¨å†…å­˜å¤§å°é€šè¿‡é…ç½®redis.confä¸­çš„maxmemoryè¿™ä¸ªå€¼æ¥å¼€å¯å†…å­˜æ·˜æ±°åŠŸèƒ½ï¼Œåœ¨å†…å­˜é™å®šçš„æƒ…å†µä¸‹æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚
è®¾ç½®æœ€å¤§å†…å­˜å¤§å°å¯ä»¥ä¿è¯rediså¯¹å¤–æä¾›ç¨³å¥æœåŠ¡ã€‚
redis å†…å­˜æ•°æ®é›†å¤§å°ä¸Šå‡åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™ï¼Œå°±ä¼šæ–½è¡Œæ•°æ®æ·˜æ±°ç­–ç•¥ã€‚redis æä¾› 6ç§æ•°æ®æ·˜æ±°ç­–ç•¥é€šè¿‡maxmemory-policyè®¾ç½®ç­–ç•¥ï¼š
* volatile-lruï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
* volatile-ttlï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°
* volatile-randomï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆserver.db[i].expiresï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°
* allkeys-lruï¼šä»æ•°æ®é›†ï¼ˆserver.db[i].dictï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
* allkeys-randomï¼šä»æ•°æ®é›†ï¼ˆserver.db[i].dictï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°
* no-envictionï¼ˆé©±é€ï¼‰ï¼šç¦æ­¢é©±é€æ•°æ®
redis ç¡®å®šé©±é€æŸä¸ªé”®å€¼å¯¹åï¼Œä¼šåˆ é™¤è¿™ä¸ªæ•°æ®å¹¶å°†è¿™ä¸ªæ•°æ®å˜æ›´æ¶ˆæ¯å‘å¸ƒåˆ°æœ¬åœ°ï¼ˆAOF æŒä¹…åŒ–ï¼‰å’Œä»æœºï¼ˆä¸»ä»è¿æ¥ï¼‰

* [ğŸ” Rediså®ç°åˆ†å¸ƒå¼é” ](http://www.redis.cn/topics/distlock.html)
* [ğŸ“š RDBä¸AOF](https://www.cnblogs.com/xingzc/p/5988080.html)

* TTL (Time To Live)



### # Redisæä¾›äº†RDBæŒä¹…åŒ–å’ŒAOFæŒä¹…åŒ–
* RDBæœºåˆ¶çš„ä¼˜åŠ¿å’Œç•¥æ–½
RDBæŒä¹…åŒ–æ˜¯æŒ‡åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜ã€‚ä¹Ÿæ˜¯é»˜è®¤çš„æŒä¹…åŒ–æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ˜¯å°±æ˜¯å°†å†…å­˜ä¸­æ•°æ®ä»¥å¿«ç…§çš„æ–¹å¼å†™å…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­,é»˜è®¤çš„æ–‡ä»¶åä¸ºdump.rdbã€‚
å¯ä»¥é€šè¿‡é…ç½®è®¾ç½®è‡ªåŠ¨åšå¿«ç…§æŒä¹…åŒ–çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥é…ç½®redisåœ¨nç§’å†…å¦‚æœè¶…è¿‡mä¸ªkeyè¢«ä¿®æ”¹å°±è‡ªåŠ¨åšå¿«ç…§ï¼Œä¸‹é¢æ˜¯é»˜è®¤çš„å¿«ç…§ä¿å­˜é…ç½®
```
save 900 1     #900ç§’å†…å¦‚æœè¶…è¿‡1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™å‘èµ·å¿«ç…§ä¿å­˜
save 300 10    #300ç§’å†…å®¹å¦‚è¶…è¿‡10ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™å‘èµ·å¿«ç…§ä¿å­˜
save 60 10000
```
#####  RDBæ–‡ä»¶ä¿å­˜è¿‡ç¨‹
**redisè°ƒç”¨fork,ç°åœ¨æœ‰äº†å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ã€‚
çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†clientè¯·æ±‚ï¼Œå­è¿›ç¨‹è´Ÿè´£å°†å†…å­˜å†…å®¹å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ã€‚ç”±äºosçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆcopy on write)çˆ¶å­è¿›ç¨‹ä¼šå…±äº«ç›¸åŒçš„ç‰©ç†é¡µé¢ï¼Œå½“çˆ¶è¿›ç¨‹å¤„ç†å†™è¯·æ±‚æ—¶osä¼šä¸ºçˆ¶è¿›ç¨‹è¦ä¿®æ”¹çš„é¡µé¢åˆ›å»ºå‰¯æœ¬ï¼Œè€Œä¸æ˜¯å†™å…±äº«çš„é¡µé¢ã€‚æ‰€ä»¥å­è¿›ç¨‹çš„åœ°å€ç©ºé—´å†…çš„æ•° æ®æ˜¯forkæ—¶åˆ»æ•´ä¸ªæ•°æ®åº“çš„ä¸€ä¸ªå¿«ç…§ã€‚
å½“å­è¿›ç¨‹å°†å¿«ç…§å†™å…¥ä¸´æ—¶æ–‡ä»¶å®Œæ¯•åï¼Œç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢åŸæ¥çš„å¿«ç…§æ–‡ä»¶ï¼Œç„¶åå­è¿›ç¨‹é€€å‡ºã€‚
client ä¹Ÿå¯ä»¥ä½¿ç”¨saveæˆ–è€…bgsaveå‘½ä»¤é€šçŸ¥redisåšä¸€æ¬¡å¿«ç…§æŒä¹…åŒ–ã€‚saveæ“ä½œæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ä¿å­˜å¿«ç…§çš„ï¼Œç”±äºredisæ˜¯ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰ clientçš„è¯·æ±‚ï¼Œè¿™ç§æ–¹å¼ä¼šé˜»å¡æ‰€æœ‰clientè¯·æ±‚ã€‚æ‰€ä»¥ä¸æ¨èä½¿ç”¨ã€‚**

å¦ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯æ¬¡å¿«ç…§æŒä¹…åŒ–éƒ½æ˜¯å°†å†…å­˜æ•°æ®å®Œæ•´å†™å…¥åˆ°ç£ç›˜ä¸€æ¬¡ï¼Œå¹¶ä¸ æ˜¯å¢é‡çš„åªåŒæ­¥è„æ•°æ®ã€‚å¦‚æœæ•°æ®é‡å¤§çš„è¯ï¼Œè€Œä¸”å†™æ“ä½œæ¯”è¾ƒå¤šï¼Œå¿…ç„¶ä¼šå¼•èµ·å¤§é‡çš„ç£ç›˜ioæ“ä½œï¼Œå¯èƒ½ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚
* **ä¼˜åŠ¿**
  *  ä¸€æ—¦é‡‡ç”¨è¯¥æ–¹å¼ï¼Œé‚£ä¹ˆä½ çš„æ•´ä¸ªRedisæ•°æ®åº“å°†åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·éå¸¸æ–¹ä¾¿è¿›è¡Œå¤‡ä»½ã€‚æ¯”å¦‚ä½ å¯èƒ½æ‰“ç®—æ²¡1å¤©å½’æ¡£ä¸€äº›æ•°æ®ã€‚
  *  æ–¹ä¾¿å¤‡ä»½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å°†ä¸€ä¸ªä¸€ä¸ªRDBæ–‡ä»¶ç§»åŠ¨åˆ°å…¶ä»–çš„å­˜å‚¨ä»‹è´¨ä¸Š
  *  RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚
  *  RDB å¯ä»¥æœ€å¤§åŒ– Redis çš„æ€§èƒ½ï¼šçˆ¶è¿›ç¨‹åœ¨ä¿å­˜ RDB æ–‡ä»¶æ—¶å”¯ä¸€è¦åšçš„å°±æ˜¯ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åè¿™ä¸ªå­è¿›ç¨‹å°±ä¼šå¤„ç†æ¥ä¸‹æ¥çš„æ‰€æœ‰ä¿å­˜å·¥ä½œï¼Œçˆ¶è¿›ç¨‹æ— é¡»æ‰§è¡Œä»»ä½•ç£ç›˜ I/O æ“ä½œã€‚
* **åŠ£åŠ¿**
  *  å¦‚æœä½ éœ€è¦å°½é‡é¿å…åœ¨æœåŠ¡å™¨æ•…éšœæ—¶ä¸¢å¤±æ•°æ®ï¼Œé‚£ä¹ˆ RDB ä¸é€‚åˆä½ ã€‚ è™½ç„¶ Redis å…è®¸ä½ è®¾ç½®ä¸åŒçš„ä¿å­˜ç‚¹ï¼ˆsave pointï¼‰æ¥æ§åˆ¶ä¿å­˜ RDB æ–‡ä»¶çš„é¢‘ç‡ï¼Œ ä½†æ˜¯ï¼Œ å› ä¸ºRDB æ–‡ä»¶éœ€è¦ä¿å­˜æ•´ä¸ªæ•°æ®é›†çš„çŠ¶æ€ï¼Œ æ‰€ä»¥å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªè½»æ¾çš„æ“ä½œã€‚ å› æ­¤ä½ å¯èƒ½ä¼šè‡³å°‘ 5 åˆ†é’Ÿæ‰ä¿å­˜ä¸€æ¬¡ RDB æ–‡ä»¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ ä¸€æ—¦å‘ç”Ÿæ•…éšœåœæœºï¼Œ ä½ å°±å¯èƒ½ä¼šä¸¢å¤±å¥½å‡ åˆ†é’Ÿçš„æ•°æ®ã€‚
  *  æ¯æ¬¡ä¿å­˜ RDB çš„æ—¶å€™ï¼ŒRedis éƒ½è¦ fork() å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ç”±å­è¿›ç¨‹æ¥è¿›è¡Œå®é™…çš„æŒä¹…åŒ–å·¥ä½œã€‚ åœ¨æ•°æ®é›†æ¯”è¾ƒåºå¤§æ—¶ï¼Œ fork() å¯èƒ½ä¼šéå¸¸è€—æ—¶ï¼Œé€ æˆæœåŠ¡å™¨åœ¨æŸæŸæ¯«ç§’å†…åœæ­¢å¤„ç†å®¢æˆ·ç«¯ï¼› å¦‚æœæ•°æ®é›†éå¸¸å·¨å¤§ï¼Œå¹¶ä¸” CPU æ—¶é—´éå¸¸ç´§å¼ çš„è¯ï¼Œé‚£ä¹ˆè¿™ç§åœæ­¢æ—¶é—´ç”šè‡³å¯èƒ½ä¼šé•¿è¾¾æ•´æ•´ä¸€ç§’ã€‚ è™½ç„¶ AOF é‡å†™ä¹Ÿéœ€è¦è¿›è¡Œ fork() ï¼Œä½†æ— è®º AOF é‡å†™çš„æ‰§è¡Œé—´éš”æœ‰å¤šé•¿ï¼Œæ•°æ®çš„è€ä¹…æ€§éƒ½ä¸ä¼šæœ‰ä»»ä½•æŸå¤±ã€‚

#####  AOFæ–‡ä»¶ä¿å­˜è¿‡ç¨‹
redisä¼šå°†æ¯ä¸€ä¸ªæ”¶åˆ°çš„å†™å‘½ä»¤éƒ½é€šè¿‡writeå‡½æ•°è¿½åŠ åˆ°æ–‡ä»¶ä¸­(é»˜è®¤æ˜¯ appendonly.aof)ã€‚
å½“redisé‡å¯æ—¶ä¼šé€šè¿‡é‡æ–°æ‰§è¡Œæ–‡ä»¶ä¸­ä¿å­˜çš„å†™å‘½ä»¤æ¥åœ¨å†…å­˜ä¸­é‡å»ºæ•´ä¸ªæ•°æ®åº“çš„å†…å®¹ã€‚å½“ç„¶ç”±äºosä¼šåœ¨å†…æ ¸ä¸­ç¼“å­˜ writeåšçš„ä¿®æ”¹ï¼Œæ‰€ä»¥å¯èƒ½ä¸æ˜¯ç«‹å³å†™åˆ°ç£ç›˜ä¸Šã€‚è¿™æ ·aofæ–¹å¼çš„æŒä¹…åŒ–ä¹Ÿè¿˜æ˜¯æœ‰å¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†ä¿®æ”¹ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å‘Šè¯‰redisæˆ‘ä»¬æƒ³è¦ é€šè¿‡fsyncå‡½æ•°å¼ºåˆ¶oså†™å…¥åˆ°ç£ç›˜çš„æ—¶æœºã€‚æœ‰ä¸‰ç§æ–¹å¼å¦‚ä¸‹ï¼ˆé»˜è®¤æ˜¯ï¼šæ¯ç§’fsyncä¸€æ¬¡ï¼‰
```
appendonly yes              //å¯ç”¨aofæŒä¹…åŒ–æ–¹å¼
# appendfsync always      //æ¯æ¬¡æ”¶åˆ°å†™å‘½ä»¤å°±ç«‹å³å¼ºåˆ¶å†™å…¥ç£ç›˜ï¼Œæœ€æ…¢çš„ï¼Œä½†æ˜¯ä¿è¯å®Œå…¨çš„æŒä¹…åŒ–ï¼Œä¸æ¨èä½¿ç”¨
appendfsync everysec     //æ¯ç§’é’Ÿå¼ºåˆ¶å†™å…¥ç£ç›˜ä¸€æ¬¡ï¼Œåœ¨æ€§èƒ½å’ŒæŒä¹…åŒ–æ–¹é¢åšäº†å¾ˆå¥½çš„æŠ˜ä¸­ï¼Œæ¨è
# appendfsync no    //å®Œå…¨ä¾èµ–osï¼Œæ€§èƒ½æœ€å¥½,æŒä¹…åŒ–æ²¡ä¿è¯
```
aof çš„æ–¹å¼ä¹ŸåŒæ—¶å¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚æŒä¹…åŒ–æ–‡ä»¶ä¼šå˜çš„è¶Šæ¥è¶Šå¤§ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨incr testå‘½ä»¤100æ¬¡ï¼Œæ–‡ä»¶ä¸­å¿…é¡»ä¿å­˜å…¨éƒ¨çš„100æ¡å‘½ä»¤ï¼Œå…¶å®æœ‰99æ¡éƒ½æ˜¯å¤šä½™çš„ã€‚å› ä¸ºè¦æ¢å¤æ•°æ®åº“çš„çŠ¶æ€å…¶å®æ–‡ä»¶ä¸­ä¿å­˜ä¸€æ¡set test 100å°±å¤Ÿäº†ã€‚

ä¸ºäº†å‹ç¼©aofçš„æŒä¹…åŒ–æ–‡ä»¶ã€‚redisæä¾›äº†bgrewriteaofå‘½ä»¤ã€‚æ”¶åˆ°æ­¤å‘½ä»¤rediså°†ä½¿ç”¨ä¸å¿«ç…§ç±»ä¼¼çš„æ–¹å¼å°†å†…å­˜ä¸­çš„æ•°æ® ä»¥å‘½ä»¤çš„æ–¹å¼ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæœ€åæ›¿æ¢åŸæ¥çš„æ–‡ä»¶ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹
* redisè°ƒç”¨fork ï¼Œç°åœ¨æœ‰çˆ¶å­ä¸¤ä¸ªè¿›ç¨‹
* å­è¿›ç¨‹æ ¹æ®å†…å­˜ä¸­çš„æ•°æ®åº“å¿«ç…§ï¼Œå¾€ä¸´æ—¶æ–‡ä»¶ä¸­å†™å…¥é‡å»ºæ•°æ®åº“çŠ¶æ€çš„å‘½ä»¤
* çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†clientè¯·æ±‚ï¼Œé™¤äº†æŠŠå†™å‘½ä»¤å†™å…¥åˆ°åŸæ¥çš„aofæ–‡ä»¶ä¸­ã€‚åŒæ—¶æŠŠæ”¶åˆ°çš„å†™å‘½ä»¤ç¼“å­˜èµ·æ¥ã€‚è¿™æ ·å°±èƒ½ä¿è¯å¦‚æœå­è¿›ç¨‹é‡å†™å¤±è´¥çš„è¯å¹¶ä¸ä¼šå‡ºé—®é¢˜ã€‚
* å½“å­è¿›ç¨‹æŠŠå¿«ç…§å†…å®¹å†™å…¥å·²å‘½ä»¤æ–¹å¼å†™åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­åï¼Œå­è¿›ç¨‹å‘ä¿¡å·é€šçŸ¥çˆ¶è¿›ç¨‹ã€‚ç„¶åçˆ¶è¿›ç¨‹æŠŠç¼“å­˜çš„å†™å‘½ä»¤ä¹Ÿå†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ã€‚
* ç°åœ¨çˆ¶è¿›ç¨‹å¯ä»¥ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è€çš„aofæ–‡ä»¶ï¼Œå¹¶é‡å‘½åï¼Œåé¢æ”¶åˆ°çš„å†™å‘½ä»¤ä¹Ÿå¼€å§‹å¾€æ–°çš„aofæ–‡ä»¶ä¸­è¿½åŠ ã€‚
éœ€è¦æ³¨æ„åˆ°æ˜¯é‡å†™aofæ–‡ä»¶çš„æ“ä½œï¼Œå¹¶æ²¡æœ‰è¯»å–æ—§çš„aofæ–‡ä»¶ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå†…å­˜ä¸­çš„æ•°æ®åº“å†…å®¹ç”¨å‘½ä»¤çš„æ–¹å¼é‡å†™äº†ä¸€ä¸ªæ–°çš„aofæ–‡ä»¶,è¿™ç‚¹å’Œå¿«ç…§æœ‰ç‚¹ç±»ä¼¼ã€‚
* **ä¼˜åŠ¿**
  * ä½¿ç”¨ AOF æŒä¹…åŒ–ä¼šè®© Redis å˜å¾—éå¸¸è€ä¹…ï¼ˆmuch more durableï¼‰ï¼šä½ å¯ä»¥è®¾ç½®ä¸åŒçš„ fsync ç­–ç•¥ï¼Œæ¯”å¦‚æ—  fsync ï¼Œæ¯ç§’é’Ÿä¸€æ¬¡ fsync ï¼Œæˆ–è€…æ¯æ¬¡æ‰§è¡Œå†™å…¥å‘½ä»¤æ—¶ fsync ã€‚ AOF çš„é»˜è®¤ç­–ç•¥ä¸ºæ¯ç§’é’Ÿ fsync ä¸€æ¬¡ï¼Œåœ¨è¿™ç§é…ç½®ä¸‹ï¼ŒRedis ä»ç„¶å¯ä»¥ä¿æŒè‰¯å¥½çš„æ€§èƒ½ï¼Œå¹¶ä¸”å°±ç®—å‘ç”Ÿæ•…éšœåœæœºï¼Œä¹Ÿæœ€å¤šåªä¼šä¸¢å¤±ä¸€ç§’é’Ÿçš„æ•°æ®ï¼ˆ fsync ä¼šåœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­åŠªåŠ›åœ°å¤„ç†å‘½ä»¤è¯·æ±‚ï¼‰ã€‚
  * AOF æ–‡ä»¶æ˜¯ä¸€ä¸ªåªè¿›è¡Œè¿½åŠ æ“ä½œçš„æ—¥å¿—æ–‡ä»¶ï¼ˆappend only logï¼‰ï¼Œ å› æ­¤å¯¹ AOF æ–‡ä»¶çš„å†™å…¥ä¸éœ€è¦è¿›è¡Œ seek ï¼Œ å³ä½¿æ—¥å¿—å› ä¸ºæŸäº›åŸå› è€ŒåŒ…å«äº†æœªå†™å…¥å®Œæ•´çš„å‘½ä»¤ï¼ˆæ¯”å¦‚å†™å…¥æ—¶ç£ç›˜å·²æ»¡ï¼Œå†™å…¥ä¸­é€”åœæœºï¼Œç­‰ç­‰ï¼‰ï¼Œ redis-check-aof å·¥å…·ä¹Ÿå¯ä»¥è½»æ˜“åœ°ä¿®å¤è¿™ç§é—®é¢˜ã€‚
Redis å¯ä»¥åœ¨ AOF æ–‡ä»¶ä½“ç§¯å˜å¾—è¿‡å¤§æ—¶ï¼Œè‡ªåŠ¨åœ°åœ¨åå°å¯¹ AOF è¿›è¡Œé‡å†™ï¼š é‡å†™åçš„æ–° AOF æ–‡ä»¶åŒ…å«äº†æ¢å¤å½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°å‘½ä»¤é›†åˆã€‚ æ•´ä¸ªé‡å†™æ“ä½œæ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œå› ä¸º Redis åœ¨åˆ›å»ºæ–° AOF æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»§ç»­å°†å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶é‡Œé¢ï¼Œå³ä½¿é‡å†™è¿‡ç¨‹ä¸­å‘ç”Ÿåœæœºï¼Œç°æœ‰çš„ AOF æ–‡ä»¶ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ è€Œä¸€æ—¦æ–° AOF æ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼ŒRedis å°±ä¼šä»æ—§ AOF æ–‡ä»¶åˆ‡æ¢åˆ°æ–° AOF æ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¯¹æ–° AOF æ–‡ä»¶è¿›è¡Œè¿½åŠ æ“ä½œã€‚
  * AOF æ–‡ä»¶æœ‰åºåœ°ä¿å­˜äº†å¯¹æ•°æ®åº“æ‰§è¡Œçš„æ‰€æœ‰å†™å…¥æ“ä½œï¼Œ è¿™äº›å†™å…¥æ“ä½œä»¥ Redis åè®®çš„æ ¼å¼ä¿å­˜ï¼Œ å› æ­¤ AOF æ–‡ä»¶çš„å†…å®¹éå¸¸å®¹æ˜“è¢«äººè¯»æ‡‚ï¼Œ å¯¹æ–‡ä»¶è¿›è¡Œåˆ†æï¼ˆparseï¼‰ä¹Ÿå¾ˆè½»æ¾ã€‚ å¯¼å‡ºï¼ˆexportï¼‰ AOF æ–‡ä»¶ä¹Ÿéå¸¸ç®€å•ï¼š ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœä½ ä¸å°å¿ƒæ‰§è¡Œäº† FLUSHALL å‘½ä»¤ï¼Œ ä½†åªè¦ AOF æ–‡ä»¶æœªè¢«é‡å†™ï¼Œ é‚£ä¹ˆåªè¦åœæ­¢æœåŠ¡å™¨ï¼Œ ç§»é™¤ AOF æ–‡ä»¶æœ«å°¾çš„ FLUSHALL å‘½ä»¤ï¼Œ å¹¶é‡å¯ Redis ï¼Œ å°±å¯ä»¥å°†æ•°æ®é›†æ¢å¤åˆ° FLUSHALL æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ã€‚

* **åŠ£åŠ¿**
  * å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼ŒAOF æ–‡ä»¶çš„ä½“ç§¯é€šå¸¸è¦å¤§äº RDB æ–‡ä»¶çš„ä½“ç§¯ã€‚
  * æ ¹æ®æ‰€ä½¿ç”¨çš„ fsync ç­–ç•¥ï¼ŒAOF çš„é€Ÿåº¦å¯èƒ½ä¼šæ…¢äº RDB ã€‚ åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æ¯ç§’ fsync çš„æ€§èƒ½ä¾ç„¶éå¸¸é«˜ï¼Œ è€Œå…³é—­ fsync å¯ä»¥è®© AOF çš„é€Ÿåº¦å’Œ RDB ä¸€æ ·å¿«ï¼Œ å³ä½¿åœ¨é«˜è´Ÿè·ä¹‹ä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä¸è¿‡åœ¨å¤„ç†å·¨å¤§çš„å†™å…¥è½½å…¥æ—¶ï¼ŒRDB å¯ä»¥æä¾›æ›´æœ‰ä¿è¯çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼ˆlatencyï¼‰ã€‚
  * AOF åœ¨è¿‡å»æ›¾ç»å‘ç”Ÿè¿‡è¿™æ ·çš„ bug ï¼š å› ä¸ºä¸ªåˆ«å‘½ä»¤çš„åŸå› ï¼Œå¯¼è‡´ AOF æ–‡ä»¶åœ¨é‡æ–°è½½å…¥æ—¶ï¼Œæ— æ³•å°†æ•°æ®é›†æ¢å¤æˆä¿å­˜æ—¶çš„åŸæ ·ã€‚ ï¼ˆä¸¾ä¸ªä¾‹å­ï¼Œé˜»å¡å‘½ä»¤ BRPOPLPUSH å°±æ›¾ç»å¼•èµ·è¿‡è¿™æ ·çš„ bug ã€‚ï¼‰ æµ‹è¯•å¥—ä»¶é‡Œä¸ºè¿™ç§æƒ…å†µæ·»åŠ äº†æµ‹è¯•ï¼š å®ƒä»¬ä¼šè‡ªåŠ¨ç”Ÿæˆéšæœºçš„ã€å¤æ‚çš„æ•°æ®é›†ï¼Œ å¹¶é€šè¿‡é‡æ–°è½½å…¥è¿™äº›æ•°æ®æ¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ã€‚ è™½ç„¶è¿™ç§ bug åœ¨ AOF æ–‡ä»¶ä¸­å¹¶ä¸å¸¸è§ï¼Œ ä½†æ˜¯å¯¹æ¯”æ¥è¯´ï¼Œ RDB å‡ ä¹æ˜¯ä¸å¯èƒ½å‡ºç°è¿™ç§ bug çš„ã€‚

### # ä¸»ä»å¤åˆ¶
**å…¨é‡åŒæ­¥**
Rediså…¨é‡å¤åˆ¶ä¸€èˆ¬å‘ç”Ÿåœ¨Slaveåˆå§‹åŒ–é˜¶æ®µï¼Œè¿™æ—¶Slaveéœ€è¦å°†Masterä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶ä¸€ä»½ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š 
-  ä»æœåŠ¡å™¨è¿æ¥ä¸»æœåŠ¡å™¨ï¼Œå‘é€SYNCå‘½ä»¤ï¼› 
-  ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°SYNCå‘½ååï¼Œå¼€å§‹æ‰§è¡ŒBGSAVEå‘½ä»¤ç”ŸæˆRDBæ–‡ä»¶å¹¶ä½¿ç”¨ç¼“å†²åŒºè®°å½•æ­¤åæ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ï¼› 
-  ä¸»æœåŠ¡å™¨BGSAVEæ‰§è¡Œå®Œåï¼Œå‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€å¿«ç…§æ–‡ä»¶ï¼Œå¹¶åœ¨å‘é€æœŸé—´ç»§ç»­è®°å½•è¢«æ‰§è¡Œçš„å†™å‘½ä»¤ï¼› 
-  ä»æœåŠ¡å™¨æ”¶åˆ°å¿«ç…§æ–‡ä»¶åä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®ï¼Œè½½å…¥æ”¶åˆ°çš„å¿«ç…§ï¼› 
-  ä¸»æœåŠ¡å™¨å¿«ç…§å‘é€å®Œæ¯•åå¼€å§‹å‘ä»æœåŠ¡å™¨å‘é€ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤ï¼› 
-  ä»æœåŠ¡å™¨å®Œæˆå¯¹å¿«ç…§çš„è½½å…¥ï¼Œå¼€å§‹æ¥æ”¶å‘½ä»¤è¯·æ±‚ï¼Œå¹¶æ‰§è¡Œæ¥è‡ªä¸»æœåŠ¡å™¨ç¼“å†²åŒºçš„å†™å‘½ä»¤ï¼›
[ä¸»ä»å¤åˆ¶åŸç†](https://www.cnblogs.com/kevingrace/p/5685332.html)
[Sentinelå“¨å…µæ¨¡å¼](https://www.cnblogs.com/jaycekon/p/6237562.html)



> todo
> redis IOæ¨¡å‹
> redisèƒ½åšæ¶ˆæ¯é˜Ÿåˆ— ä¼˜ç‚¹ç¼ºç‚¹  
    * æ— æ³•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å¾ˆå¤šç‰¹æ€§
    * æ•°æ®ä¸¢å¤±æ— æ³•è§£å†³
    * æ— æ³•çŸ¥é“æ¶ˆæ¯çš„å¤„ç†ç»“æœï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œè¡¥æ•‘çš„é˜²æ­¢åªèƒ½æ˜¯é‡æ–°ä¸¢å›redisæ¶ˆæ¯é˜Ÿåˆ—
> åˆ†å¸ƒå¼é”ä¼˜ç‚¹ç¼ºç‚¹
> ä¸»ä» æ•°æ®æ€ä¹ˆåŒæ­¥    SLAVEOF 127.0.0.1:6379
> æ•°æ®ç»“æ„çš„å®ç°åŸç†  
> é›†ç¾¤å’Œåˆ†å¸ƒå¼é›†ç¾¤çš„ç»“æ„